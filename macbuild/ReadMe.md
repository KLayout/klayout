Relevant KLayout version: 0.25.9

# 1. Introduction
This directory "macbuild" contains different files required for building KLayout (http://www.klayout.de/) version 0.25 or later for different 64-bit Mac OSXs including:
* Yosemite    (10.10)
* El Capitan  (10.11)
* Sierra      (10.12)
* High Sierra (10.13)
* Mojave      (10.14)

By default, Qt framework is "Qt5" from **MacPorts** (https://www.macports.org/) which is usually located under:
```
/opt/local/libexec/qt5/
```

Alternatively, you can use "Qt5" from **Homebrew** (https://brew.sh/) which is usually located under:
```
/usr/local/opt/qt/
```
Please refer to Section # 5.1 of this document regarding the use of Qt5 from **Homebrew**.

### IMPORTANT
By default, the supported script languages, i.e., Ruby and Python, are those standard ones bundled with the OS.

# 2. Non-OS-standard script language support
You may want to use a non-OS-standard script language such as Python 3.7 from **Homebrew** or **Anaconda3** (https://www.anaconda.com/download/#macos) in combination with KLayout.

Section # 5.1 of this document explains the use of **Homebrew**; Section # 5.2, **Anaconda3**.<br>
Please try these if you feel they are useful.

# 3. Use-cases
### 3A. Debug build using the OS-standard script languages
1. Make a symbolic link (if it does not exist) from the parent directory (where 'build.sh' exists) to 'build4mac.py', that is,
```
  build4mac.py -> macbuild/build4mac.py
```
2. Invoke 'build4mac.py' with appropriate options ("-d" for debug build):
```
$ cd /where/'build.sh'/exists
$ ./build4mac.py -d
```
3. Confirm successful build (it will take about one hour).
4. Run 'build4mac.py' again with the same options used in 2. PLUS "-y" to deploy executables and libraries (including Qt's frameworks) under "klayout.app" bundle. The buddy command-line tools (strm*) will also be deployed in this step.
```
$ ./build4mac.py -d -y
```
5. Copy/move the generated bundle ("klayout.app") to your "/Applications" directory for installation.

### 3B. Release build using the non-OS-standard Ruby 2.4 and Python 3.6 both from MacPorts
1. Make a symbolic link (if it does not exist) from the parent directory (where 'build.sh' exists) to 'build4mac.py', that is,
```
build4mac.py -> macbuild/build4mac.py
```
2. Invoke 'build4mac.py' with appropriate options:
```
$ cd /where/'build.sh'/exists
$ ./build4mac.py -r mp24 -p mp36
```
3. Confirm successful build (it will take about one hour).
4. Run 'build4mac.py' again with the same options used in 2. PLUS "-Y" to deploy executables and libraries under "klayout.app" bundle. The buddy command-line tools (strm*) will also be deployed in this step.
```
$ ./build4mac.py -r mp24 -p mp36 -Y
```
* [-Y|--DEPLOY] option deploys KLayout's dylibs and executables only.
That is, paths to other modules (Ruby, Python, and Qt5 Frameworks) remain unchanged (absolute paths in your development environment).

5. Copy/move the generated bundle ("klayout.app") to your "/Applications" directory for installation.

----

# 4. Making a DMG installer
You can make a DMG installer using another Python script 'makeDMG4mac.py'.
This script requires a directory generated by 'build4mac.py' with [-y|-Y] option (refer to 3A.4 & 3B.4)

1. Make a symbolic link (if it does not exist) from the parent directory (where 'build.sh' exists) to 'makeDMG4mac.py', that is,
```
makeDMG4mac.py -> macbuild/makeDMG4mac.py
```
2. Invoke 'makeDMG4mac.py' with -p and -m options, for example,
```
$ cd /where/'build.sh'/exists
$ ./makeDMG4mac.py -p qt5.pkg.macos-HighSierra-release -m
```
----

# 5. Alternative building options
### 5.1 Python 3.7 from Homebrew, Qt 5.10.1 from Homebrew

Homebrew's installation of python3 (`brew install python3`) places a `Python.framework` in `/usr/local/opt/python/Frameworks/Python.framework/`, which you can use to build KLayout from. Qt can also be downloaded from brew with `brew install qt`.

```
# Build step
./build4mac.py -p B37 -q Qt5Brew
# build with log
./build4mac.py -p B37 -q Qt5Brew 2>&1 | tee qt5.build.macos-HighSierra-release-version.log


# Deploy step
./build4mac.py -p B37 -q Qt5Brew -y  # normal deploy
./build4mac.py -p B37 -q Qt5Brew -y -v 3 2>&1 | tee qt5.pkg.macos-HighSierra-release.log  # deploy with debug options

# Packaging step
./makeDMG4mac.py -p qt5.pkg.macos-HighSierra-release -m -q Qt5101

```

#### Known issues

Because we link python to `/usr/local/opt/python/Frameworks/Python.framework/`, updating python from brew might break KLayout if the new version is incompatible. To fix this, it is better to link python directly to `/usr/local/Cellar/python/3.6.4_4/Frameworks/Python.framework`, but that might complicate release builds, because that assumes users have the exact version of python installed by brew.

### 5.2 Qt 5.9.7, Ruby 2.5, Python 3.7 (as of Sep. 2019) from Anaconda3
If you wish to use all the three components (Qt5, Ruby, and Python) bundled with **Anaconda3**, this is the case, <br>
where the build script assumes **Anaconda3** is installed under **$HOME/anaconda3/**. <br>
This case does not support the standard packaging step due to a known issue in solving inter-library dependencies.<br>
Instead, you need to move/copy the deployed application bundle ("klayout.app") to your "/Applications" directory for installation.

```
# Build step
./build4mac.py -q Qt5Ana3 -r ana3 -p ana3

# Deploy step
./build4mac.py -q Qt5Ana3 -r ana3 -p ana3 -Y  # not '-y'

# Packaging step
-- N/A --

# Manual installation step
$ cd  qt5.pkg.macos-{OS_NAME}-release

$ mv  klayout.app  klayout-anaconda3.app

$ cp -Rp  klayout-anaconda3.app  /Applications
```

#### Additional steps to start KLayout using the Python in **Anaconda3**
```
$ export PYTHONHOME=$HOME/anaconda3

$ open /Applications/klayout-anaconda3.app
```

You can make an application bundle (icon) for the above Bash script using MacOS' **Automator** tool.<br>
A related Github ticket is [here](https://github.com/Kazzz-S/klayout/issues/34).

[End of File]

----
#### Creating a template DMG file

Starting from a `klayout-0.25.8-macOS-Mojave-1-Qt5101.dmg` file:

```
hdiutil convert klayout-0.25.8-macOS-Mojave-1-Qt5101.dmg -format UDRW -o work-KLayout.dmg
hdiutil attach work-KLayout.dmg -readwrite -noverify -quiet -mountpoint tempKLayout -noautoopen
rm -rf tempKLayout/klayout.app/Contents
hdiutil detach tempKLayout
rm macbuild/Resources/klayoutDMGTemplate.dmg
hdiutil convert work-KLayout.dmg -format UDZO -imagekey zlib-level=9 -o macbuild/Resources/klayoutDMGTemplate.dmg
```
