Author: Thomas Ferreira de Lima
email: thomas@tlima.me

## Notes
To use the stubgen script for the three main modules, run the following from the root folder of the repository:
`$  python ./src/pymod/stubgen.py db >! src/pymod/distutils_src/klayout/dbcore.pyi`
`$  python ./src/pymod/stubgen.py rdb >! src/pymod/distutils_src/klayout/rdbcore.pyi`
`$  python ./src/pymod/stubgen.py tl >! src/pymod/distutils_src/klayout/tlcore.pyi`

To compare the generated stubs with a python self-inspection of the klayout module, try the following:
Navigate to `./src/pymod/distutils_src`.
Run, for example:
`$ stubtest klayout.tlcore`

TODO:
- [ ] Integrate above scripts with CI
## Old notes
This is a temporary file containing some development notes regarding generating py stubs (https://mypy.readthedocs.io/en/stable/stubgen.html) for klayout python's C-extension. This enables syntax highlighting and type checking from compatible IDEs like VS Code.

It is possible to annotate C-extension docstrings to include function signatures, which helps with argument inspection.
https://stackoverflow.com/questions/1104823/python-c-extension-method-signatures-for-documentation/41245451?newreg=47206c01d91a44b6ab7b8c3bc75488f2

This is not enough for type hints or code completion from IDEs. For that, we need to create stubs. Luckily, there is a nice tool from mypy called stubgen:
https://mypy.readthedocs.io/en/stable/stubgen.html

The stub generated by the stubgen does not produce the docstrings, though. There is an open issue on github about that.
https://github.com/python/mypy/issues/11965

I patched the stubgen program temporarily to fit our needs. See branch: https://github.com/thomaslima/mypy/tree/issue-klayout

Run stubgen as such:
`$ stubgen -m klayout.dbcore -o src/pymod/distutils_src/`
`$ stubgen -m klayout.tlcore -o src/pymod/distutils_src/`
`$ stubgen -m klayout.rdbcore -o src/pymod/distutils_src/`
`$ stubgen -m klayout.libcore -o src/pymod/distutils_src/`

TODO:
- [x] 1. Complete signature generation for all methods in pyaModule.cc. A line containing func(arg1, arg2) should suffice. Multiple lines automatically generate overloading.
- [x] 2. Patch stubgen so that it can create docstrings. (Or wait for issue 11965 to be resolved)
- [x] 3. Generate stubs for klayout.*core.
- [ ] 4. Manually check and backannotate types in klayout.*core.pyi.
- [ ] 5. How to update the stubs if klayout code changes? Manually for now.

New stubgen:
`$  python ./src/pymod/stubgen.py db >! src/pymod/distutils_src/klayout/dbcore.pyi`
`$  python ./src/pymod/stubgen.py rdb >! src/pymod/distutils_src/klayout/rdbcore.pyi`
`$  python ./src/pymod/stubgen.py tl >! src/pymod/distutils_src/klayout/tlcore.pyi`

To verify with mypi:
Navigate to `./src/pymod/distutils_src`.
Run, for example:
`$ stubtest klayout.tlcore`

NEW APPROACH:
- [x] 1. Use klayout.tl to inspect all classes and methods in pya.
- [x] 2. Figure out last few bugs.
    - DPoint has a method with "=" when it should have been "*=". There must be an issue with the gsiDeclInternal algorithms.
    - Some inner classes, e.g. LogicalOp inside CompoundRegionOperationNode are not returning
- [x] 3. Manually check and compare to mypy's output.
    - Looks good, but there are a few discrepancies between actual python module and stubs. Namely, deprecated methods were not included in the stub. The opposite is sometimes true as well, though for newer, experimental classes e.g. `klayout.dbcore.GenericDeviceCombiner.combine_devices`.